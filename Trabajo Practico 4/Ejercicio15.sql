DROP TABLE IF EXISTS Accesos;
DROP TABLE IF EXISTS AuditoriaAccesos;

CREATE TABLE Accesos (
	AccesoId INT PRIMARY KEY AUTO_INCREMENT,
    UsuarioId INT NOT NULL,
    FechaAcceso DATETIME NOT NULL,
    DireccionIp VARCHAR(45) NOT NULL
);
CREATE TABLE AuditoriaAccesos (
	AuditoriaId INT PRIMARY KEY AUTO_INCREMENT,
    UsuarioId INT NOT NULL,
    FechaAcceso DATETIME NOT NULL,
    DireccionIp VARCHAR(45) NOT NULL,
    EstadoAcceso VARCHAR(20) NOT NULL -- Ejemplos: 'Exitoso', 'Fallido'
);
INSERT INTO Accesos (UsuarioId, FechaAcceso, DireccionIp) VALUES
(1, '2024-10-27 10:15:00', '192.168.1.1'),
(2, '2024-10-27 11:20:00', '192.168.1.1'),
(3, '2024-10-27 12:25:00', '192.168.1.1'),
(4, '2024-10-28 13:30:00', '192.168.1.4'),
(5, '2024-10-28 14:35:00', '192.168.1.5'),
(6, '2024-10-28 15:40:00', '192.168.1.6'),
(7, '2024-10-27 16:45:00', '192.168.1.1'),
(8, '2024-10-28 17:50:00', '192.168.1.8'),
(9, '2024-10-28 18:55:00', '192.168.1.9'),
(10, '2024-10-28 19:00:00', '192.168.1.10'),
(11, '2024-10-27 10:15:00', '192.168.1.11'),
(12, '2024-10-27 11:20:00', '192.168.1.12'),
(13, '2024-10-27 12:25:00', '192.168.1.13'),
(14, '2024-10-27 13:30:00', '192.168.1.14'),
(15, '2024-10-27 14:35:00', '192.168.1.15'),
(16, '2024-10-27 15:40:00', '192.168.1.16'),
(17, '2024-10-27 16:45:00', '192.168.1.17'),
(18, '2024-10-27 17:50:00', '192.168.1.18'),
(19, '2024-10-27 18:55:00', '192.168.1.19'),
(20, '2024-10-27 19:00:00', '192.168.1.20'),
(21, '2024-10-26 10:15:00', '192.168.1.21'),
(22, '2024-10-26 11:20:00', '192.168.1.22'),
(23, '2024-10-26 12:25:00', '192.168.1.23'),
(24, '2024-10-26 13:30:00', '192.168.1.24'),
(25, '2024-10-26 14:35:00', '192.168.1.25'),
(26, '2024-10-26 15:40:00', '192.168.1.26'),
(27, '2024-10-26 16:45:00', '192.168.1.27'),
(28, '2024-10-26 17:50:00', '192.168.1.28'),
(29, '2024-10-26 18:55:00', '192.168.1.29'),
(30, '2024-10-26 19:00:00', '192.168.1.30'),
(31, '2024-10-25 10:15:00', '192.168.1.31'),
(32, '2024-10-25 11:20:00', '192.168.1.32'),
(33, '2024-10-25 12:25:00', '192.168.1.33'),
(34, '2024-10-25 13:30:00', '192.168.1.34'),
(35, '2024-10-25 14:35:00', '192.168.1.35'),
(36, '2024-10-25 15:40:00', '192.168.1.36'),
(37, '2024-10-25 16:45:00', '192.168.1.37'),
(38, '2024-10-25 17:50:00', '192.168.1.38'),
(39, '2024-10-25 18:55:00', '192.168.1.39'),
(40, '2024-10-25 19:00:00', '192.168.1.40'),
(41, '2024-10-24 10:15:00', '192.168.1.41'),
(42, '2024-10-24 11:20:00', '192.168.1.42'),
(43, '2024-10-24 12:25:00', '192.168.1.43'),
(44, '2024-10-24 13:30:00', '192.168.1.44'),
(45, '2024-10-24 14:35:00', '192.168.1.45'),
(46, '2024-10-24 15:40:00', '192.168.1.46'),
(47, '2024-10-24 16:45:00', '192.168.1.47'),
(48, '2024-10-24 17:50:00', '192.168.1.48'),
(49, '2024-10-24 18:55:00', '192.168.1.49'),
(50, '2024-10-24 19:00:00', '192.168.1.50'),
(51, '2024-10-23 10:15:00', '192.168.1.51'),
(52, '2024-10-23 11:20:00', '192.168.1.52'),
(53, '2024-10-23 12:25:00', '192.168.1.53'),
(54, '2024-10-23 13:30:00', '192.168.1.54'),
(55, '2024-10-23 14:35:00', '192.168.1.55'),
(56, '2024-10-23 15:40:00', '192.168.1.56'),
(57, '2024-10-23 16:45:00', '192.168.1.57'),
(58, '2024-10-23 17:50:00', '192.168.1.58'),
(59, '2024-10-23 18:55:00', '192.168.1.59'),
(60, '2024-10-23 19:00:00', '192.168.1.60'),
(61, '2024-10-22 10:15:00', '192.168.1.61'),
(62, '2024-10-22 11:20:00', '192.168.1.62'),
(63, '2024-10-22 12:25:00', '192.168.1.63'),
(64, '2024-10-22 13:30:00', '192.168.1.64'),
(65, '2024-10-22 14:35:00', '192.168.1.65'),
(66, '2024-10-22 15:40:00', '192.168.1.66'),
(67, '2024-10-22 16:45:00', '192.168.1.67'),
(68, '2024-10-22 17:50:00', '192.168.1.68'),
(69, '2024-10-22 18:55:00', '192.168.1.69'),
(70, '2024-10-22 19:00:00', '192.168.1.70'),
(71, '2024-10-21 10:15:00', '192.168.1.71'),
(72, '2024-10-21 11:20:00', '192.168.1.72'),
(73, '2024-10-21 12:25:00', '192.168.1.73'),
(74, '2024-10-21 13:30:00', '192.168.1.74'),
(75, '2024-10-21 14:35:00', '192.168.1.75'),
(76, '2024-10-21 15:40:00', '192.168.1.76'),
(77, '2024-10-21 16:45:00', '192.168.1.77'),
(78, '2024-10-21 17:50:00', '192.168.1.78'),
(79, '2024-10-21 18:55:00', '192.168.1.79'),
(80, '2024-10-21 19:00:00', '192.168.1.80'),
(81, '2024-10-20 10:15:00', '192.168.1.81'),
(82, '2024-10-20 11:20:00', '192.168.1.82'),
(83, '2024-10-20 12:25:00', '192.168.1.83'),
(84, '2024-10-20 13:30:00', '192.168.1.84'),
(85, '2024-10-20 14:35:00', '192.168.1.85'),
(86, '2024-10-20 15:40:00', '192.168.1.86'),
(87, '2024-10-20 16:45:00', '192.168.1.87'),
(88, '2024-10-20 17:50:00', '192.168.1.88'),
(89, '2024-10-20 18:55:00', '192.168.1.89'),
(90, '2024-10-20 19:00:00', '192.168.1.90'),
(91, '2024-10-19 10:15:00', '192.168.1.91'),
(92, '2024-10-19 11:20:00', '192.168.1.92'),
(93, '2024-10-19 12:25:00', '192.168.1.93'),
(94, '2024-10-19 13:30:00', '192.168.1.94'),
(95, '2024-10-19 14:35:00', '192.168.1.95'),
(96, '2024-10-19 15:40:00', '192.168.1.96'),
(97, '2024-10-19 16:45:00', '192.168.1.97'),
(98, '2024-10-19 17:50:00', '192.168.1.98'),
(99, '2024-10-19 18:55:00', '192.168.1.99'),
(100, '2024-10-19 19:00:00', '192.168.1.100'),
(101, '2024-10-18 10:15:00', '192.168.1.101'),
(102, '2024-10-18 11:20:00', '192.168.1.102'),
(103, '2024-10-18 12:25:00', '192.168.1.103'),
(104, '2024-10-18 13:30:00', '192.168.1.104'),
(105, '2024-10-18 14:35:00', '192.168.1.105'),
(106, '2024-10-18 15:40:00', '192.168.1.106'),
(107, '2024-10-18 16:45:00', '192.168.1.107'),
(108, '2024-10-18 17:50:00', '192.168.1.108'),
(109, '2024-10-18 18:55:00', '192.168.1.109'),
(110, '2024-10-18 19:00:00', '192.168.1.110'),
(111, '2024-10-17 10:15:00', '192.168.1.117'),
(112, '2024-10-17 11:20:00', '192.168.1.117'),
(113, '2024-10-17 12:25:00', '192.168.1.117'),
(114, '2024-10-17 13:30:00', '192.168.1.117'),
(115, '2024-10-17 14:35:00', '192.168.1.115'),
(116, '2024-10-27 15:40:00', '192.168.1.120'),
(117, '2024-10-17 16:45:00', '192.168.1.117'),
(118, '2024-10-27 17:50:00', '192.168.1.120'),
(119, '2024-10-27 18:55:00', '192.168.1.120'),
(120, '2024-10-27 19:00:00', '192.168.1.120');

DROP PROCEDURE IF EXISTS AuditarAcceso;
DELIMITER $$
CREATE PROCEDURE AuditarAcceso()
BEGIN 
	DECLARE fin_Cursor BOOL DEFAULT FALSE;
    
    DECLARE UsuarioIdCursor INT;
    DECLARE FechaAccesoCursor DATETIME;
    DECLARE DireccionIpCursor VARCHAR(45);
    DECLARE CantidadAccesoCursor INT;
    DECLARE EstadoAccesoCursor VARCHAR(10);
    
    DECLARE Cursor_Auditoria CURSOR FOR
    SELECT UsuarioId, FechaAcceso, DireccionIp 
    FROM Accesos
    ORDER BY AccesoId DESC
    LIMIT 100;
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET fin_Cursor = TRUE;
    
    OPEN Cursor_Auditoria;
		FETCH Cursor_Auditoria INTO UsuarioIdCursor, FechaAccesoCursor, DireccionIpCursor;
        
        WHILE (NOT fin_Cursor) DO
			SELECT COUNT(*) INTO CantidadAccesoCursor
            FROM Accesos
            WHERE DireccionIp = DireccionIpCursor AND FechaAcceso >= NOW() - INTERVAL 24 HOUR;
            
            IF CantidadAccesoCursor > 3 THEN 
				SET EstadoAccesoCursor = 'Fallido';
			ELSE
				SET EstadoAccesoCursor = 'Exitoso';
			END IF;
            
            INSERT INTO AuditoriaAccesos(UsuarioId, FechaAcceso, DireccionIp, EstadoAcceso)
            VALUES
            (UsuarioIdCursor, FechaAccesoCursor, DireccionIpCursor, EstadoAccesoCursor);
            
			FETCH Cursor_Auditoria INTO UsuarioIdCursor, FechaAccesoCursor, DireccionIpCursor;
        END WHILE;
    CLOSE Cursor_Auditoria;
END $$
DELIMITER ;

CALL AuditarAcceso();
SELECT * FROM AuditoriaAccesos;